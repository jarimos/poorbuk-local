!function(t,e,s){var i,h,o,d,n,r,l,p,a=(i="PsActivityStream",h=e,peepso.observer,o="scroll.ps-activity-stream",d=+peepsodata.is_admin,n=+peepsodata.currentuserid,r=+peepsodata.userid,l=h("#peepso_post_id").val()||void 0,p=h("#peepso_context").val()||void 0,peepso.createClass(i,{__constructor:function(t,e){this.$el=h(t),this.$recent=h("#ps-activitystream-recent"),this.$loading=h("#ps-activitystream-loading"),this.$noPosts=h("#ps-no-posts"),this.$noPostsMatch=h("#ps-no-posts-match"),this.$noMorePosts=h("#ps-no-more-posts"),this.$filters=h(".ps-js-activitystream-filter"),this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadIds=[],this.loadLimit=+peepsodata.activity_limit_below_fold,this.loadButtonEnabled=+peepsodata.loadmore_enable,this.loadButtonRepeat=this.loadButtonEnabled?+peepsodata.loadmore_repeat:0,this.loadButtonTemplate=e.template_load_more,this.isPermalink=+e.is_permalink,this.hideFromGuest=+e.hide_from_guest,this.loadLimit=0<this.loadLimit?this.loadLimit:3,this.streamData={},h("[id^=peepso_stream_]").each(h.proxy(function(t,e){var s=e.id.replace(/^peepso_/,""),i=e.value;this.streamData[s]=i,"stream_id"===s&&(d||"core_scheduled"!==i?this.allowHideMyPosts(!0):this.allowHideMyPosts(!1))},this)),h(document).on("peepso_login_shown",function(){this.$loading.hide()}),this.$filters.on("click",".ps-js-dropdown-toggle",h.proxy(this.onFilterToggle,this)),this.$filters.on("click","[data-option-value]",h.proxy(this.onFilterSelect,this)),this.$filters.on("click",".ps-js-cancel",h.proxy(this.onFilterCancel,this)),this.$filters.on("click",".ps-js-apply",h.proxy(this.onFilterApply,this)),this.$filters.on("click","[type=text]",h.proxy(this.onFilterFocus,this)),this.$filters.on("keyup","[type=text]",h.proxy(this.onFilterKeyup,this)),this.$filters.on("click",".ps-js-search",h.proxy(this.onFilterSearch,this)),this.loadEverything="#everything"===window.location.hash,this.loadEverything&&(confirm("Are you sure want to load every post?")||(this.loadEverything=!1));var s=h("#ps-activitystream-search");this.search(s.eq(0).val()),peepso.observer.addAction("peepso_stream_reset",h.proxy(function(){this.search(s.eq(0).val())},this))},search:function(t){var e,s;t=h.trim(t||""),this.searchKeyword=t,this.searchMode="exact",this.reset(),(e=h(".ps-js-activitystream-filter").filter("[data-id=peepso_search]").find(".ps-js-dropdown-toggle").find("span")).length&&(t?(s=e.data("keyword"),s+=t+'<i class="ps-icon-remove"></i>',e.one("click","i",h.proxy(function(t){h("#ps-activitystream-search").val(""),this.search("")},this))):s=e.data("empty"),e.html(s))},autoload:function(e){if(e===this._token&&!this.loading)return!n&&this.hideFromGuest?(this.$loading.hide(),!1):void(this.shouldLoad()?(this.loading=!0,this.load(e).done(h.proxy(function(){this.loading=!1,this.isPermalink||this.loadEnd||this.autoload(e)},this))):this.loadButtonEnabled&&!this.$loadButton?(this.$loadButton=h(this.loadButtonTemplate).insertAfter(this.$el),this.$loadButton.one("click",h.proxy(function(t){h(t.currentTarget).remove(),this.autoload(e)},this))):this._onScrollEnabled||(this._onScrollEnabled=!0,h(window).on(o,e,h.proxy(this.onScroll,this))))},shouldLoad:function(){var t,e,s,i=this.$el.children(".ps-js-activity");return!this.loadEnd&&(!i.length||!!this.loadEverything||(this.loadButtonEnabled&&this.loadButtonRepeat?i.length%this.loadButtonRepeat!=0||!!this.$loadButton&&(delete this.$loadButton,!0):!!(t=i.slice(0-this.loadLimit).eq(0)).length&&(e=this.loadButtonEnabled&&!this.$loadButton?t.eq(0).offset():t[0].getBoundingClientRect(),s=window.innerHeight||document.documentElement.clientHeight,e.top<s)))},load:function(i){var o,a=this,t=peepso.disableAuth().disableError();return o=_.extend({uid:n,user_id:r,post_id:l,context:p,page:this.loadPage,search:this.searchKeyword||void 0,search_mode:this.searchKeyword&&this.searchMode||void 0,pinned:1===this.loadPage?1:void 0},this.streamData||{}),o=peepso.observer.applyFilters("show_more_posts",o),h.Deferred(function(s){a.$loading.show(),t.postJson("activity.show_posts_per_page",o,function(t){if(i===a._token){if(a.$loading.hide(),0<t.data.found_posts){var e=+t.data.act_id;e?-1===a.loadIds.indexOf(e)&&(a.loadIds.push(e),a.render(t.data.posts)):a.render(t.data.posts),a.loadPage++}else a.loadEnd=!0;a.loadEnd&&(1<o.page?a.$noMorePosts.show():a.searchKeyword?a.$noPostsMatch.show():a.$noPosts.show()),s.resolve()}})})},reset:function(){this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadIds=[],this._onScrollEnabled=!1,h(window).off(o),this.$loadButton&&(this.$loadButton.remove(),this.$loadButton=void 0),this.$el.empty().hide(),this.$recent.empty(),this.$noMorePosts.hide(),this.$noPosts.hide(),this.$noPostsMatch.hide(),this._token=(new Date).getTime(),this.autoload(this._token)},render:function(t){t=t.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"');var e=h(t),i=this.searchKeyword,o=this.searchMode;(e=peepso.observer.applyFilters("peepso_activity",e)).find(".ps-js-activity-content, .ps-comment-item, .ps-stream-quote").each(function(){var t=h(this),e=t.html();e=peepso.observer.applyFilters("peepso_activity_content",e),t.html(e)}),i&&e.find(".ps-js-activity-content").each(function(){var t=h(this),e=t.html(),s=[i];"any"===o&&(s=_.filter(i.split(" "),function(t){return t})),s=_.map(s,function(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}),s=RegExp("("+s.join("|")+")(?![^<>]+>)","ig"),e=e.replace(s,'<span class="ps-text--highlight">$1</span>'),t.html(e)}),this.$el.is(":hidden")&&this.$el.show();try{e.appendTo(this.$el)}catch(t){}e.hide().fadeIn(1e3,function(){h(document).trigger("ps_activitystream_loaded")}),h("textarea[name=comment]",e).ps_autosize()},allowHideMyPosts:function(t){var e,s,i=this.$filters.filter("[data-id=peepso_stream_filter_show_my_posts]"),o=i.find(".ps-js-dropdown-toggle");t?o.removeAttr("disabled"):(o.attr("disabled","disabled"),h("#"+i.data("id")).val(1),(e=i.find("[data-option-value]")).find("[type=radio][value=0]")[0].checked=!1,e.find("[type=radio][value=1]")[0].checked=!0,s=e.filter("[data-option-value=1]"),o.find("span").text(s.find("span").text()),o.find('[class*="ps-icon-"]').attr("class",s.find('[class*="ps-icon-"]').attr("class")))},onScroll:_.throttle(function(t){var e=t.data;this.autoload(e)},1),onFilterToggle:_.debounce(function(t){var e,s=h(t.currentTarget),i=s.closest(".ps-js-activitystream-filter"),o=i.data("id").replace(/^peepso_/,""),a=this.streamData[o];i.is(":visible")&&(e=i.find("[type=radio]").filter('[value="'+a+'"]')).length&&(e[0].checked=!0)},1),onFilterSelect:function(t){var e=h(t.currentTarget),s=e.find("[type=radio]");t.preventDefault(),t.stopPropagation(),_.defer(function(){s[0].checked=!0})},onFilterCancel:function(t){var e=h(t.currentTarget),s=e.closest(".ps-js-activitystream-filter"),i=s.find(".ps-js-dropdown-toggle");i.focus()},onFilterApply:function(t){var e=h(t.currentTarget),s=e.closest(".ps-js-activitystream-filter"),i=s.find(".ps-js-dropdown-toggle"),o=h("#"+s.data("id")),a=s.find("[type=radio]:checked").closest("[data-option-value]"),n=a.data("optionValue"),r=s.data("id").replace(/^peepso_/,"");o.val(n),this.streamData[r]=n,i.find("span").text(a.find("span").text()),i.find('[class*="ps-icon-"]').attr("class",a.find('[class*="ps-icon-"]').attr("class")),i.focus(),"stream_id"===r&&(d||"core_scheduled"!==n?this.allowHideMyPosts(!0):this.allowHideMyPosts(!1)),this.reset()},onFilterFocus:function(t){t.stopPropagation()},onFilterKeyup:function(t){t.stopPropagation(),13===t.which&&h(t.currentTarget).closest(".ps-js-activitystream-filter").find(".ps-js-search").click()},onFilterSearch:function(t){var e=h(t.currentTarget),s=e.closest(".ps-js-activitystream-filter"),i=s.find(".ps-js-dropdown-toggle"),o=h("#"+s.data("id")),a=s.find("[type=radio]:checked").closest("[data-option-value]"),n=s.find("[type=text]"),r=a.data("optionValue"),d=(s.data("id").replace(/^peepso_/,""),n.val().trim()),l=i.find("span").data(d?"keyword":"empty");o.val(r),this.searchKeyword=d,this.searchMode=r,l=d?(l=i.find("span").data("keyword"))+d+'<i class="ps-icon-remove"></i>':i.find("span").data("empty"),i.find("span").html(l).off("click","i").one("click","i",h.proxy(function(t){var e=h(t.target).closest(".ps-js-dropdown-toggle"),s=e.closest(".ps-js-activitystream-filter"),i=s.find("[type=text]"),o=h("#"+s.data("id"));t.stopPropagation(),i.val(""),o.val(""),e.find("span").html(e.find("span").data("empty")),this.searchKeyword="",this.searchMode="",this.reset()},this)),i.focus(),this.reset()}}));jQuery(function(t){var e,s=t("#ps-activitystream");s.length&&(e=peepsodata&&peepsodata.activity||{},new a(s[0],e))})}(window,jQuery);