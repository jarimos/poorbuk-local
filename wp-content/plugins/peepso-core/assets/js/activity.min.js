function PsActivity(){this.current_post=null,this.is_ajax_loading={},this.is_editing={}}PsActivity.prototype.init=function(){var e=this;this.$post_container=jQuery("#ps-activitystream"),jQuery(".comment-container").each(function(t,e){0===jQuery("div",e).length&&jQuery(this).hide()}),jQuery(".cstream-respond").each(function(t,e){0===jQuery("div",e).not(".comment-container").length&&jQuery(this).hide(),jQuery("textarea[name=comment]",e).ps_autosize()}),jQuery(document).on("click",".ps-js-content-excerpt-toggle",function(t){var e,s=jQuery(t.currentTarget);if(!s.data("single-act"))return t.preventDefault(),t.stopPropagation(),(e=s.closest(".ps-js-content-excerpt")).length&&e.hide().siblings(".ps-js-content-full").show(),!1}),jQuery(document).on("ps_activitystream_loaded peepso_repost_shown peepso_report_shown ps_activitystream_append",function(t){e.toggle_anchor_target(),e.setup_comment_textarea(),e.update_pinned_color(),e.parseXFBML()}),jQuery(document).on("ps_comment_save",function(){e.setup_comment_textarea()}),jQuery(document).trigger("ps_activitystream_loaded"),jQuery(document).on("ps_comment_addon_added ps_comment_addon_removed",function(t,e){var s,o;o=(s=(e=jQuery(e)).closest(".ps-js-addons")).closest(".ps-textarea-wrapper").find("textarea"),"ps_comment_addon_added"===t.type?(e.siblings().hide(),s.show()):"ps_comment_addon_removed"===t.type&&(e.siblings(":visible").length?s.show():s.hide()),o.trigger("input")}),peepso.observer.addAction("peepso_delete_post",function(){peepsodata.activity&&+peepsodata.activity.is_permalink&&window.location.reload()})},PsActivity.prototype.setup_comment_textarea=function(){var t=jQuery('[data-type="stream-newcomment"] textarea');t.off("keydown.peepso").on("keydown.peepso",jQuery.proxy(function(t){return this.on_comment_keydown(t)},this)),t.off("keyup.peepso").on("keyup.peepso",jQuery.proxy(function(t){t.stopPropagation(),this.update_beautifier(t.target)},this))},PsActivity.prototype.update_beautifier=_.throttle(function(r){_.defer(_.bind(function(){var t,e,s,o=jQuery(r),i=o.data("ps-beautifier");i||(o.addClass("ps-tagging-textarea"),(t=o.parent(".ps-tagging-wrapper")).length||(o.wrap("<div class=ps-tagging-wrapper />"),t=o.parent(".ps-tagging-wrapper")),(i=t.children(".ps-tagging-beautifier")).length||(i=jQuery("<div class=ps-tagging-beautifier />")).prependTo(t),o.data("ps-beautifier",i),o.focus()),(s=window._wpemojiSettings||{})&&s.supports&&(s.supports.everything=!0),e=o.val()||"",e=(e=peepso.observer.applyFilters("peepso_postbox_beautifier",e,o)).replace(/<(?!\/?ps_)/g,"&lt;").replace(/<(\/?)ps_/g,"<$1").replace(/\r?\n/g,"<br />"),i.html(e)},this))},100),PsActivity.prototype.on_comment_keydown=function(t){if(t.shiftKey||t.ctrlKey)return!0;if(13===(t.keyCode?t.keyCode:t.which)){if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent))return!0;var e=jQuery(t.target),s=""===jQuery.trim(e.val());if(ps_observer.apply_filters("comment_can_submit",{el:e,can_submit:!s}).can_submit)return this.comment_save(e.data("act-id")),t.preventDefault(),!1}return!0},PsActivity.prototype.toggle_anchor_target=function(){var e=new RegExp(location.host),t=jQuery(".ps-stream-content .cstream-attachment a, .ps-stream-content .content a, .ps-share-status-inner a").filter(function(){var t=jQuery(this).attr("href");return"http"===t.substring(0,4)&&!e.test(t)});0==peepsodata.open_in_new_tab?t.removeAttr("target"):t.attr("target","_blank")},PsActivity.prototype.action_like=function(t,e){if(this.action_like_progress)return!1;this.action_like_progress=!0;var s={act_id:e,uid:peepsodata.currentuserid},o=this,i=jQuery(t),r=jQuery(".ps-js-act-like--"+e),a=i.hasClass("liked"),n=+r.data("count")+(a?-1:1);r.html();return i.toggleClass("liked"),n<1?r.hide():(1==n?r.html('<a href="#" onclick="return activity.show_likes('+e+');">1 '+peepsodata.like_text+"</a>"):r.html('<a href="#" onclick="return activity.show_likes('+e+');">'+n+" "+peepsodata.like_text_plural+"</a>"),r.show()),$PeepSo.postJson("activity.like",s,function(t){o.action_like_progress=!1,t.success?(i.replaceWith(t.data.like_html),r.data("count",t.data.count),0<t.data.count?r.html(t.data.count_html).show():r.hide()):(psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time),i.toggleClass("liked"),r.html(html),1<=+r.data("count")?r.show():r.hide())}),!1},PsActivity.prototype.action_repost=function(i){var t={act_id:i,uid:peepsodata.currentuserid,user_id:peepsodata.userid},e=jQuery("#repost-dialog .dialog-title").html();return content=jQuery("#ajax-loader-gif").html(),pswindow.show(e,content),$PeepSo.postJson("activity.ajax_show_post",t,function(t){if(0!=t.success){var e=jQuery("#repost-dialog .dialog-content").html(),s=jQuery("#repost-dialog .dialog-action").html(),o=t.data.html.trim();o=o.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),o=peepso.observer.applyFilters("peepso_activity_content",o),e=(e=e.replace("{post-content}",o)).replace("{post-id}",i+""),pswindow.set_content(e).set_actions(s).refresh(),jQuery(document).trigger("peepso_repost_shown"),jQuery("#share-post-box","#ps-window").autosize(),jQuery("#ps-window").find(".ps-js-dropdown-menu").css({left:0,right:"auto"})}else pswindow.hide()}),!1},PsActivity.prototype.submit_repost=function(){var t=jQuery("#postbox-post-id","#ps-window").val(),e={content:jQuery("#share-post-box","#ps-window").val(),id:peepsodata.currentuserid,uid:peepsodata.currentuserid,repost:t,acc:jQuery("#cWindowContent input[name='repost_acc']").val(),type:"activity"};return e=ps_observer.apply_filters("postbox_req",e),$PeepSo.postJson("postbox.post",e,function(t){if(t.success&&(pswindow.hide(),0==+peepsodata.userid||+peepsodata.currentuserid==+peepsodata.userid)){var e=peepso.observer.applyFilters("peepso_activity_content",t.data.html);jQuery(e).hide().prependTo("#ps-activitystream").fadeIn("slow",function(){jQuery(document).trigger("peepso_repost_added")}),jQuery("html, body").animate({scrollTop:jQuery("#ps-activitystream").offset().top},1e3)}}),!1},PsActivity.prototype.action_report=function(i){var t={act_id:i,uid:peepsodata.currentuserid,user_id:peepsodata.userid},e=jQuery("#activity-report-title").html();content=jQuery("#ajax-loader-gif").html(),pswindow.show(e,content),$PeepSo.postJson("activity.ajax_show_post",t,function(t){var e=jQuery("#activity-report-content").html(),s=t.data.html.trim();s=s.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),e=(e=e.replace("{post-content}",s)).replace("{post-id}",i+""),actions=jQuery("#activity-report-actions").html(),pswindow.set_content(e).set_actions(actions).refresh();var o=jQuery("#cWindowContent .ps-js-report-desc");o.find("textarea").off("input").on("input",_.throttle(function(t){o.find(".ps-js-counter").html(t.target.value.length)},500)).triggerHandler("input"),jQuery(document).trigger("peepso_report_shown")})},PsActivity.prototype.submit_report=function(){var t=jQuery("#cWindowContent .ps-js-report-error").hide(),e=jQuery("#cWindowContent select.ps-js-report-type"),s=jQuery("#cWindowContent .ps-js-report-desc textarea"),o=e.val(),i=jQuery.trim(s.val());if(!o){var r=jQuery("#report-error-select-reason").text();return t.text(r).show(),!1}if(e.find("option:selected").data("needReason")&&!i){r=jQuery("#report-error-empty-reason").text();return t.text(r).show(),!1}var a=jQuery("#postbox-report-popup #postbox-post-id","#ps-window").val(),n=ps_observer.apply_filters("activity_report_params",{act_id:a,uid:peepsodata.currentuserid,reason:o,reason_desc:i}),p=ps_observer.apply_filters("activity_report_action","activity.report");return peepso.postJson(p,n,function(t){t.success?(jQuery(window).trigger("report.submitted",t),pswindow.set_content(t.notices[0]).fade_out(pswindow.fade_time)):(pswindow.hide(),psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.action_delete=function(o,e,t){return pswindow.confirm_delete(jQuery.proxy(function(){var t=jQuery.extend({uid:peepsodata.currentuserid,postid:o},e||{});pswindow.hide(),peepso.postJson("activity.delete",t,jQuery.proxy(function(t){var e,s;if(this.toggle_comment_box(o,!1),t.success){if(s=jQuery("#ps-activitystream-recent"),!(e=jQuery(".ps-js-activity").filter('[data-post-id="'+o+'"]')).length)return void peepso.observer.doAction("peepso_delete_post",o);e.css({transition:"opacity .5s","-webkit-transition":"opacity .5s"}),setTimeout(function(){e.css("opacity",0),setTimeout(function(){e.slideUp(function(){e.remove(),s.children().length||s.hide(),peepso.observer.doAction("peepso_delete_post",o)})},700)},0)}},this))},this),t),!1},PsActivity.prototype.action_pin=function(t,e){var s={postid:t,pinstatus:e,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.pin",s,function(t){t.success&&window.location.reload()}),!1},PsActivity.prototype.action_remove_link_preview=function(t,e){var s=jQuery(".ps-js-activity--"+e);return s.length&&(s.find(".ps-stream-body .ps-stream-attachments").empty(),s.find(".ps-stream-actions .actaction-removepreview").remove(),peepso.postJson("activity.remove_link_preview",{postid:t,uid:peepsodata.currentuserid})),!1},PsActivity.prototype.on_commentbox_change=function(t){var e=jQuery(t),s=e.val();s.length>peepsodata.postsize&&(s=s.substring(0,peepsodata.postsize),e.val(s));var o=""===jQuery.trim(s),i=ps_observer.apply_filters("comment_show_button",{el:e,show:!o}),r=e.parents(".cstream-form-input").next(".cstream-form-submit");i.show?(r.show(),r.find(".ps-comment-actions").show(),r.find(".ps-button-action").removeAttr("disabled")):(r.hide(),r.find(".ps-comment-actions").hide(),r.find(".ps-button-action").attr("disabled","disabled"))},PsActivity.prototype.comment_save=function(o,t){if(!this.is_ajax_loading["save-comment-"+o]){var i=this,r=jQuery("#act-new-comment-"+o+" .cstream-form-text");t&&t.tagName&&(r=jQuery(t).closest("#act-new-comment-"+o).find(".cstream-form-text")),jQuery("#act-new-comment-"+o+" .ps-comment-loading").show(),jQuery("#act-new-comment-"+o+" .ps-comment-actions").hide();var a=jQuery(r),e=a.val();return req=ps_observer.apply_filters("comment_req",{act_id:o,uid:peepsodata.currentuserid,content:e,last:jQuery(".comment-container[data-act-id="+o+"] .cstream-comment:last").data("comment-id")},r),jQuery(document).trigger("ps_comment_beforesave",[o,r]),this.is_ajax_loading["save-comment-"+o]=!0,a.attr("disabled","disabled"),$PeepSo.postJson("activity.makecomment",req,function(t){if(i.is_ajax_loading["save-comment-"+o]=!1,a.removeAttr("disabled"),t.success){var e=peepso.observer.applyFilters("peepso_activity_content",t.data.html),s=jQuery(e);jQuery(".comment-container[data-act-id="+o+"]").show(),s.appendTo(".comment-container[data-act-id="+o+"]").hide().fadeIn(2e3),jQuery("#peepso-wrap").trigger("comment.saved",[o,r,req,s]),jQuery(document).trigger("ps_comment_save")}else psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time);jQuery(document).trigger("ps_comment_aftersave",[o,r]),activity.comment_cancel(o),activity.current_post=null,jQuery("#act-new-comment-"+o+" .ps-comment-loading").hide(),jQuery("#act-new-comment-"+o+" .ps-comment-actions").hide(),jQuery("#act-new-comment-"+o+" .ps-button-action").attr("disabled","disabled"),void 0!==t.data.has_max_comments&&i.toggle_comment_box(o,t.data.has_max_comments)}),!1}},PsActivity.prototype.comment_action_edit=function(s,t){if(!(0<jQuery("#comment-item-"+s+" .cstream-content .cstream-edit").length)){var o=this,i=jQuery(t).closest("#comment-item-"+s);if(void 0===this.is_ajax_loading["comment-edit-"+s]||!1===this.is_ajax_loading["comment-edit-"+s]){this.is_ajax_loading["comment-edit-"+s]=!0;var e={postid:s,uid:peepsodata.currentuserid};$PeepSo.postJson("activity.editcomment",e,function(t){if(t.success){var e=jQuery(t.data.html);jQuery("[data-type='stream-comment-content']",i).first().hide().after(e),jQuery(".ps-comment-media",i).hide(),jQuery("#peepso-wrap").trigger("comment_edit.shown",[s,e]),ps_observer.do_action("comment_edit",s,e),jQuery(".cstream-edit textarea",i).on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize().off("keyup.peepso").on("keyup.peepso",function(t){t.stopPropagation(),activity.update_beautifier(t.target)}).trigger("keyup.peepso"),o.is_ajax_loading["comment-edit-"+s]=!1}})}return!1}},PsActivity.prototype.option_canceleditcomment=function(t,e){var s=jQuery(e).closest("#comment-item-"+t);return 0<s.length&&(jQuery(".cstream-edit",s).remove(),jQuery("[data-type='stream-comment-content']",s).show(),jQuery(".ps-comment-media",s).show()),!1},PsActivity.prototype.option_savecomment=function(s,t){var o=jQuery(t).closest("#comment-item-"+s);if(0<o.length){var e=jQuery(".cstream-edit textarea",o).val();jQuery(".cstream-edit textarea",o).attr("disabled","disabled"),jQuery(".ps-edit-loading",o).show(),jQuery(".cstream-edit button",o).hide();var i=jQuery(".cstream-edit textarea",o),r=ps_observer.apply_filters("comment_req",{postid:s,uid:peepsodata.currentuserid,post:e},i);jQuery(document).trigger("ps_comment_beforesave",[s,i]),$PeepSo.postJson("activity.savecomment",r,function(t){if(t.success){jQuery(".cstream-edit",o).remove();var e=peepso.observer.applyFilters("peepso_activity_content",t.data.html);jQuery("[data-comment-id="+s+"] [data-type='stream-comment-content']").html(e),jQuery("[data-type='stream-comment-content']",o).show(),jQuery("[data-comment-id="+s+"] .cstream-content > .cstream-attachments").html(t.data.attachments),jQuery(".cstream-content > .cstream-attachments",o).show(),jQuery("span.ps-stream-status-action",o).html(t.data.actions),jQuery(document).trigger("ps_comment_save")}else psmessage.show("",t.notices[0]),jQuery(".cstream-edit button",o).show(),jQuery(".ps-edit-loading",o).hide(),jQuery(".cstream-edit textarea",o).removeAttr("disabled")})}return!1},PsActivity.prototype.comment_action_delete=function(e){var s=this;pswindow.confirm_delete(function(){var t={postid:e,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.delete",t,function(t){s.toggle_comment_box(e,!1),t.success&&jQuery(".ps-comment-item[data-comment-id="+e+"]").remove(),pswindow.hide()}),!1})},PsActivity.prototype.comment_action_remove_preview=function(t){var e=jQuery("#comment-item-"+t);return e.length&&(e.find(".ps-comment-media").empty(),e.find(".actaction-removepreview").remove(),peepso.postJson("activity.remove_link_preview",{postid:t,uid:peepsodata.currentuserid})),!1},PsActivity.prototype.comment_action_report=function(r){var t={act_id:r};return $PeepSo.postJson("activity.ajax_show_comment",t,function(t){var e=jQuery("#activity-report-title").html(),s=jQuery("#activity-report-content").html(),o=t.data.html.trim();o=o.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),s=(s=s.replace("{post-content}",o)).replace("{post-id}",r+""),ps_observer.add_filter("activitystream_notice_container",function(t,e){return"#comment-item-"+e+" .cstream-more"},10,2),actions=jQuery("#activity-report-actions").html(),pswindow.show(e,s).set_actions(actions).refresh();var i=jQuery("#cWindowContent .ps-js-report-desc");i.find("textarea").off("input").on("input",_.throttle(function(t){i.find(".ps-js-counter").html(t.target.value.length)},500)).triggerHandler("input"),jQuery("#ps-window").one("pswindow.hidden",function(){ps_observer.remove_filter("activitystream_notice_container",function(t,e){return"#comment-item-"+e+" .cstream-more"},10)})}),!1},PsActivity.prototype.comment_action_reply=function(t,e,s,o){return peepso.comment.reply(t,e,s,o),!1},PsActivity.prototype.comment_action_like=function(t,e){if(!this.comment_action_like_progress){this.comment_action_like_progress=!0;var s={act_id:e,uid:peepsodata.currentuserid},o=this,i=jQuery(t),r=jQuery(".ps-js-act-like--"+e),a=i.hasClass("liked"),n=+r.data("count")+(a?-1:1);r.html();return i.toggleClass("liked"),n<1?r.hide():(1==n?r.html('<a href="#" onclick="return activity.show_likes('+e+');">1 '+peepsodata.like_text+"</a>"):r.html('<a href="#" onclick="return activity.show_likes('+e+');">'+n+" "+peepsodata.like_text_plural+"</a>"),r.show()),$PeepSo.postJson("activity.like",s,function(t){o.comment_action_like_progress=!1,t.success?(i.replaceWith(t.data.like_html),r.data("count",t.data.count),0<t.data.count?r.html(t.data.count_html).show():r.hide()):(psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time),i.toggleClass("liked"),r.html(html),1<=+r.data("count")?r.show():r.hide())}),!1}},PsActivity.prototype.comment_cancel=function(t){var e=jQuery("div#act-new-comment-"+t),s=e.find(".cstream-form-text");return e.find(".cstream-form-submit").hide(),e.find(".ps-js-commentbox-addons").hide(),s.val("").trigger("autosize.resize"),ps_observer.apply_filters("comment_cancel",s),!1},PsActivity.prototype.show_likes=function(e){var t={act_id:e,uid:peepsodata.currentuserid},s=this,o="likes-"+e;return this.is_ajax_loading[o]&&(this.is_ajax_loading[o].ret&&this.is_ajax_loading[o].ret.abort(),this.is_ajax_loading[o]=!1),this.is_ajax_loading[o]=$PeepSo.postJson("activity.get_like_names",t,function(t){jQuery("#act-like-"+e+" a").replaceWith(t.data.html),s.is_ajax_loading[o]=!1}),!1},PsActivity.prototype.show_comments=function(t,e){return peepso.comment.show_previous(t,e),!1},PsActivity.prototype.option_edit=function(t,o){var i="edit-post-"+o;if(!this.is_editing[i]){this.is_editing[i]=!0;var r=jQuery(".ps-js-activity--"+o),a=r.find(".ps-js-activity-content"),n=r.find(".ps-js-activity-edit"),p=r.find(".ps-stream-actions"),c=r.find(".ps-stream-body .cstream-attachments"),d=r.find(".ps-js-activity-extras");return n.ps_postbox({fetch:function(e,s){peepso.postJson("activity.editpost",{uid:peepsodata.currentuserid,postid:t},function(t){t.success&&(e.update(t.data),e.$text.off("keyup.peepso").on("keyup.peepso",function(t){t.stopPropagation(),activity.update_beautifier(t.target)}).trigger("keyup.peepso")),s()})},cancel:jQuery.proxy(function(t){this.is_editing[i]=!1,n.ps_postbox("destroy"),a.show()},this),submit:jQuery.proxy(function(t,e,s){(e=jQuery.extend({},e,{uid:peepsodata.currentuserid,act_id:o})).post=e.content,delete e.content,peepso.postJson("activity.savepost",e,jQuery.proxy(function(t){if(t.success){this.is_editing[i]=!1,n.ps_postbox("destroy");var e=peepso.observer.applyFilters("peepso_activity_content",t.data.html);a.html(e).show(),c.html(t.data.attachments),p.html(t.data.actions),d.html(t.data.extras||""),t.data&&t.data.timestamp&&r.find(".ps-stream-meta .ps-stream-time").html(t.data.timestamp)}else psmessage.show("",t.errors[0]);jQuery(document).trigger("peepso_post_edit_saved"),s()},this))},this)}),a.hide(),n.show(),!1}},PsActivity.prototype.option_canceledit=function(t){this.is_editing["edit-post-"+t]=!1;var e=jQuery(".ps-js-activity--"+t);return 0<e.length&&(jQuery(".cstream-edit",e).remove(),jQuery(".cstream-attachment",e).show()),!1},PsActivity.prototype.option_cancel_edit_description=function(t){var e=jQuery(".ps-js-modal-attachment--"+t);return 0<e.length&&(jQuery(".cstream-edit",e).remove(),jQuery(".cstream-attachment",e).show()),!1},PsActivity.prototype.option_savepost=function(e){var s=jQuery(".ps-js-activity--"+e);if(0<s.length){var t=jQuery(".cstream-edit textarea",s).val();jQuery(".cstream-edit textarea",s).attr("disabled","disabled"),jQuery(".ps-edit-loading",s).show(),jQuery(".cstream-edit button",s).hide();var o=ps_observer.apply_filters("postbox_req_edit",{act_id:e,uid:peepsodata.currentuserid,post:t},jQuery(".cstream-edit textarea",s));$PeepSo.postJson("activity.savepost",o,jQuery.proxy(function(t){jQuery(".cstream-edit",s).remove(),t.success?(this.is_editing["edit-post-"+e]=!1,jQuery(".ps-stream-body .cstream-attachment",s).html(t.data.html),jQuery(".ps-stream-body .cstream-attachments",s).html(t.data.attachments),jQuery(".ps-stream-actions",s).html(t.data.actions)):psmessage.show("",t.errors[0]),jQuery(".ps-stream-body .cstream-attachment, .ps-stream-body .cstream-attachments",s).show(),jQuery(document).trigger("peepso_post_edit_saved")},this))}return!1},PsActivity.prototype.option_save_description=function(t,e,s){var o=jQuery(".ps-js-modal-attachment--"+t);if(0<o.length){var i=jQuery(".cstream-edit textarea",o),r=i.val();jQuery(".cstream-edit textarea",o).attr("disabled","disabled"),jQuery(".ps-edit-loading",o).show(),jQuery(".cstream-edit button",o).hide();var a={act_id:t,type:e,object_id:s,uid:peepsodata.currentuserid,description:r};a=ps_observer.apply_filters("caption_req",a,i),$PeepSo.postJson("activity.save_description",a,function(t){jQuery(".cstream-edit",o).remove(),jQuery(".ps-stream-attachment",o).html(t.data.html).show()})}return!1},PsActivity.prototype.option_hide=function(e){var t={act_id:e,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.hidepost",t,function(t){t.success&&jQuery(".ps-js-activity--"+e).remove()}),!1},PsActivity.prototype.option_block=function(e,t){var s={uid:peepsodata.currentuserid,user_id:t};return peepso.postJson("activity.blockuser",s,function(t){t.success?jQuery(".ps-js-activity--"+e).remove():t.errors&&alert(t.errors[0])}),!1},PsActivity.prototype.change_post_privacy=function(t,e){var s,o,i,r,a,n="[class*=ps-icon-]";return t=jQuery(t),s=jQuery(".ps-js-privacy--"+e),o=s.find(".ps-js-dropdown-toggle"),i=o.find(n).attr("class"),r=t.find(n).attr("class"),o.find(n).attr("class",r),o.css("opacity",.5),(a=this.change_post_privacy)._xhr||(a._xhr={}),a._xhr[e]&&a._xhr[e].ret.abort(),a._xhr[e]=peepso.postJson("activity.change_post_privacy",{uid:peepsodata.currentuserid,user_id:peepsodata.userid,act_id:e,acc:t.data("option-value"),_wpnonce:peepsodata.peepso_nonce},function(t){o.css("opacity",""),t.has_errors&&(o.find(n).attr("class",i),psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.toggle_comment_box=function(t,e){var s=jQuery("#act-new-comment-"+t);if(s.length<=0){var o=jQuery("#comment-item-"+t);if(o.length<=0&&(o=jQuery(".ps-js-activity--"+t)),0<o.length){s=o.parent();var i=(o.parent().attr("id")+"").split("-").pop();s=jQuery("#act-new-comment-"+i)}}return s.length<=0||(e?s.hide():s.show()),!1},PsActivity.prototype.delete_activity=function(t,e){var s=jQuery.extend({act_id:t,uid:peepsodata.currentuserid,_wpnonce:jQuery("#_delete_nonce").val()},e||{}),o=jQuery("[data-act-delete-id="+t+"]"),i="";return 0<o.length&&(i=o.text()),pswindow.confirm_delete(function(){$PeepSo.postJson("activity.ajax_delete_activity",s,function(t){t.success?window.location.reload():psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time)})},i),!1},PsActivity.prototype.edit_activity_description=function(t,e,s){var o=jQuery(".ps-js-modal-attachment--"+t);if(!(0<o.find(".cstream-edit textarea").length)){var i={act_id:t,type:e,object_id:s,uid:peepsodata.currentuserid};return this.edit_activity_description_xhr&&this.edit_activity_description_xhr.ret&&this.edit_activity_description_xhr.ret.abort(),this.edit_activity_description_xhr=$PeepSo.postJson("activity.edit_description",i,function(t){if(t.success){var e=jQuery(t.data.html);o.find(".ps-stream-attachment").first().hide().after(e),jQuery("#peepso-wrap").trigger("post_edit.shown",[t.data.act_id,e]),o.find(".cstream-edit textarea").on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize().focus()}}),!1}},PsActivity.prototype.remove_broken_thumbnails=function(){jQuery(".ps-media-thumbnail img").each(function(){var t=new Image,e=this;t.onerror=function(){jQuery(e).closest(".ps-media-thumbnail").remove()},t.src=e.src})},PsActivity.prototype.update_pinned_color=_.debounce(function(){var t,e,s,o,i,r=jQuery(".ps-stream__post-pin span"),a=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/;r.length&&(t=r.eq(0).closest(".ps-stream").find("a").eq(0).css("color"),e=r.css("color"),r.css("backgroundColor",t),t=t.match(a),e=e.match(a),t&&e&&(s=[+t[1],+t[2],+t[3]],o=[+e[1],+e[2],+e[3]],i=0,_.each(s,function(t,e){i+=(s[e]-o[e])*(s[e]-o[e])}),Math.sqrt(i)<50&&(e[1]=+e[1]+(30<+e[1]?-30:30),e[2]=+e[2]+(30<+e[2]?-30:30),e[3]=+e[3]+(30<+e[3]?-30:30),e="rgba("+e[1]+","+e[2]+","+e[3]+",1)",r.css("color",e))))},500),PsActivity.prototype.parseXFBML=_.throttle(function(){peepso.util.fbParseXFBML()},2e3),function(t){activity=new PsActivity,t(function(){activity.remove_broken_thumbnails(),activity.init()})}(jQuery);